<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa de Pol√≠gonos</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; overflow:hidden; }
header { background-color: #0056b3; color: white; padding: 10px; height:50px; }
header h2 { margin:0; font-size:18px; display:inline-block; }
header span { float:right; line-height:30px; }

#map { position: fixed; top: 50px; left: 0; width: 100%; height: calc(100% - 50px); z-index:0; }

#tabla-container {
  position: absolute;
  top: 50px;
  right: 0;
  width: 50%;
  height: calc(100% - 50px);
  background: #ffffffd9;
  border: 2px solid #999;
  border-radius: 8px;
  overflow: hidden;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
}

#tabla-header { background-color: #0056b3; color:white; padding:5px; cursor: move; font-weight:bold; text-align:center; border-radius:5px 5px 0 0; }
#tabla-body { display:flex; flex-direction:column; flex:1; overflow:hidden; padding:0; }

#botonera, #filtros, #edicion-masiva {
  flex-shrink: 0;
  padding: 5px;
  background:#f7f7f7;
  border-bottom:1px solid #ccc;
}

#edicion-masiva {
  background: #e8f4f8;
  border: 1px solid #0056b3;
  margin: 2px;
  border-radius: 4px;
}

#edicion-masiva .titulo-edicion {
  font-weight: bold;
  color: #0056b3;
  margin-bottom: 5px;
  text-align: center;
}

#edicion-masiva .fila-edicion {
  display: flex;
  align-items: center;
  gap: 2px;
}

#edicion-masiva input {
  border: 1px solid #ccc;
  background: white;
  padding: 2px 4px;
  font-size: 11px;
  text-transform: uppercase;
}

#tabla-scroll {
  flex:1;
  overflow-y:auto;
  padding:5px;
}

#botonera-inferior {
  flex-shrink: 0;
  background:#f7f7f7;
  border-top:1px solid #ccc;
  padding:8px;
  text-align:center;
}

#tablaPoligonos {
  border-collapse: collapse;
  width: 100%;
}

#tablaPoligonos thead th { 
  background-color:#0056b3; 
  color:white; 
  font-weight:bold; 
  font-size:11px; 
  text-align:left;
  padding: 4px;
  user-select: none;
}

#tablaPoligonos thead th.sortable {
  cursor: pointer;
  position: relative;
  padding-right: 20px;
}

#tablaPoligonos thead th.sortable:hover {
  background-color: #003f80;
}

#tablaPoligonos thead th.sortable:after {
  content: '‚áÖ';
  position: absolute;
  right: 5px;
  opacity: 0.5;
  font-size: 12px;
}

#tablaPoligonos thead th.sortable.asc:after {
  content: '‚ñ≤';
  opacity: 1;
  color: yellow;
}

#tablaPoligonos thead th.sortable.desc:after {
  content: '‚ñº';
  opacity: 1;
  color: yellow;
}

#tablaPoligonos tbody tr { height:24px; }
#tablaPoligonos td { text-align:left; vertical-align:middle; padding: 2px 4px; }
#tablaPoligonos td input { 
  width: 95%; 
  border:none; 
  background:transparent; 
  font-size:11px; 
  padding:1px; 
  box-sizing:border-box; 
  text-transform:uppercase; 
}

#tablaPoligonos td input:hover, 
#tablaPoligonos td input:focus { background:#eef; outline:none; }
#tablaPoligonos input[type="color"] { width:30px; height:20px; padding:0; border:none; }

button { 
  margin-top:2px; 
  background-color:#0056b3; 
  color:white; 
  border:none; 
  padding:6px 10px; 
  cursor:pointer; 
  border-radius:4px; 
  font-size:11px; 
}
button:hover { background-color:#003f80; }

#editarColumnas { background-color:#28a745; }
#editarColumnas:hover { background-color:#1e7e34; }

tr.seleccionado { background-color:#FFFF99 !important; }

.menu-grabar { 
  display:none; 
  position:absolute; 
  background:white; 
  border:1px solid #ccc; 
  border-radius:8px; 
  box-shadow:0 2px 8px rgba(0,0,0,0.2); 
  min-width:160px; 
  z-index:2000; 
  bottom:60px; 
  right:60px; 
}
.menu-grabar div { padding:8px 12px; font-size:11px; cursor:pointer; }
.menu-grabar div:hover { background:#f0f0f0; }

</style>
</head>
<body>

<header>
<h2>Mapa de Pol√≠gonos - {{ usuario }}</h2>
<span><a href="/logout" style="color:white;">Cerrar sesi√≥n</a></span>
</header>

<div id="map"></div>

<div id="tabla-container">
  <div id="tabla-header">Editar atributos</div>

  <div id="tabla-body">
    <div id="botonera">
      <label>Color en bloque:</label>
      <select id="colorBloque">
        <option value="">-- ELEGIR COLOR --</option>
        {% for c in [
            {"nombre":"ROJO","codigo":"#FF0000"},{"nombre":"VERDE","codigo":"#00FF00"},{"nombre":"AZUL","codigo":"#0000FF"},
            {"nombre":"VERDE MENTA","codigo":"#B5EAD7"},{"nombre":"DURAZNO SUAVE","codigo":"#FFDAC1"},{"nombre":"LAVANDA","codigo":"#CBAACB"},
            {"nombre":"VERDE CLARO","codigo":"#E2F0CB"},{"nombre":"AMARILLO","codigo":"#FFFF00"},{"nombre":"NARANJA","codigo":"#FFA500"},
            {"nombre":"MORADO","codigo":"#800080"},{"nombre":"CYAN","codigo":"#00FFFF"},{"nombre":"MAGENTA","codigo":"#FF00FF"},
            {"nombre":"GRIS","codigo":"#808080"},{"nombre":"NEGRO","codigo":"#000000"},{"nombre":"BLANCO","codigo":"#FFFFFF"}
        ] %}
        <option value="{{ c.codigo }}">{{ c.nombre }}</option>
        {% endfor %}
      </select>
      <button id="aplicarColor">Aplicar</button>
      <button id="seleccionarFiltrados" style="background-color:#28a745;">Seleccionar</button>
      <button id="deseleccionarTodos" style="background-color:#dc3545;">Deseleccionar</button>
      <button id="btnLimpiar" style="background-color:#ffc107;">LIMPIAR</button>
    </div>

    <div id="filtros">
      <input type="text" placeholder="Sel" data-col="0" style="width:40px;">
      <input type="text" placeholder="Nombre" data-col="1" style="width:120px;">
      <input type="text" placeholder="Has" data-col="2" style="width:49px;">
      <input type="text" placeholder="Status" data-col="3" style="width:56px;">
      <input type="text" placeholder="Status1" data-col="4" style="width:56px;">
      <input type="text" placeholder="Status2" data-col="5" style="width:56px;">
      <input type="text" placeholder="Status3" data-col="6" style="width:56px;">
      <input type="text" placeholder="Partido" data-col="7" style="width:80px;">
      <input type="text" placeholder="Color" data-col="8" style="width:60px;">
    </div>

    <div id="edicion-masiva">
      <div class="titulo-edicion">‚úèÔ∏è EDICI√ìN MASIVA DE COLUMNAS</div>
      <div class="fila-edicion">
        <span style="width:40px; font-size:10px;">Sel</span>
        <input type="text" id="edit-nombre" placeholder="Nombre" style="width:120px;">
        <input type="text" id="edit-has" placeholder="Has" style="width:40px;">
        <input type="text" id="edit-status" placeholder="Status" style="width:56px;">
        <input type="text" id="edit-status1" placeholder="Status1" style="width:56px;">
        <input type="text" id="edit-status2" placeholder="Status2" style="width:80px;">
        <input type="text" id="edit-status3" placeholder="Status3" style="width:56px;">
        <input type="text" id="edit-partido" placeholder="Partido" style="width:80px;">
        <button id="editarColumnas">‚úèÔ∏è EDITAR COLUMNAS</button>
      </div>
    </div>

    <div id="tabla-scroll">
      <table id="tablaPoligonos">
        <thead>
          <tr>
            <th>Sel</th>
            <th class="sortable" data-col="1">Nombre Productor</th>
            <th class="sortable" data-col="2">Has</th>
            <th class="sortable" data-col="3">Status</th>
            <th class="sortable" data-col="4">Status1</th>
            <th class="sortable" data-col="5">Status2</th>
            <th class="sortable" data-col="6">Status3</th>
            <th class="sortable" data-col="7">Ptdo</th>
            <th>Color</th>
          </tr>
        </thead>
        <tbody>
        {% for p in poligonos %}
          <tr data-index="{{ loop.index0 }}">
            <td><input type="checkbox" class="selectFila"></td>
            <td><input type="text" value="{{ p.name }}"></td>
            <td><input type="text" value="{{ p.superficie }}"></td>
            <td><input type="text" value="{{ p.status }}"></td>
            <td><input type="text" value="{{ p.status1 }}"></td>
            <td><input type="text" value="{{ p.status2 }}"></td>
            <td><input type="text" value="{{ p.status3 }}"></td>
            <td><input type="text" value="{{ p.partido }}"></td>
            <td><input type="color" value="{{ p.color }}" class="colorInput"></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="botonera-inferior">
      <button id="btn-grabar">üíæ GUARDAR ‚ñº</button>
      <button id="exportarPDF" style="background-color:#28a745;">üìÑ EXPORTAR PDF</button>
      <div id="menu-grabar" class="menu-grabar">
        <div id="opcion-grabar">üíæ Guardar cambios</div>
        <div id="opcion-grabar-como">üìù Guardar como...</div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
const poligonos = {{ poligonos|tojson }};
const leafletPoligonos = [];
const seleccionados = new Set();

const map = L.map('map').setView([-35, -63], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap' }).addTo(map);

poligonos.forEach((p, idx)=>{
  if(p.coords && p.coords.length>0){
    const poly = L.polygon(p.coords,{color:"#000000",weight:0.5,fillColor:p.color,fillOpacity:0.6})
      .addTo(map)
      .bindPopup("<b>"+p.name+"</b><br>"+p.superficie+" has");
    poly.index = idx;
    poly.on('click',()=>{ toggleSeleccion(idx); scrollFila(idx); });
    leafletPoligonos.push(poly);
  } else leafletPoligonos.push(null);
});

// ORDENAMIENTO SIMPLE
let lastSortCol = null;
let sortAsc = true;

document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', function() {
        if(seleccionados.size === 0) {
            alert('‚ö†Ô∏è Seleccione al menos un registro para ordenar');
            return;
        }
        
        const colIdx = parseInt(this.getAttribute('data-col'));
        
        if(lastSortCol === colIdx) {
            sortAsc = !sortAsc;
        } else {
            sortAsc = true;
            lastSortCol = colIdx;
        }
        
        document.querySelectorAll('th.sortable').forEach(h => h.classList.remove('asc', 'desc'));
        this.classList.add(sortAsc ? 'asc' : 'desc');
        
        sortSelected(colIdx, sortAsc);
    });
});

function sortSelected(colIdx, ascending) {
    const tbody = document.querySelector('#tablaPoligonos tbody');
    const selected = [];
    
    seleccionados.forEach(idx => {
        const row = tbody.querySelector(`tr[data-index="${idx}"]`);
        if(row) {
            const val = row.querySelectorAll('input')[colIdx].value;
            selected.push({
                row: row,
                val: colIdx === 2 ? parseFloat(val) || 0 : val.toUpperCase()
            });
        }
    });
    
    selected.sort((a, b) => {
        if(typeof a.val === 'number') {
            return ascending ? a.val - b.val : b.val - a.val;
        }
        return ascending ? a.val.localeCompare(b.val) : b.val.localeCompare(a.val);
    });
    
    const firstRow = selected[0].row;
    const allRows = Array.from(tbody.children);
    const insertPos = allRows.indexOf(firstRow);
    
    selected.forEach(item => item.row.remove());
    
    if(insertPos === 0) {
        selected.reverse().forEach(item => tbody.insertBefore(item.row, tbody.firstChild));
    } else {
        const ref = tbody.children[insertPos - 1];
        selected.forEach(item => ref.after(item.row));
    }
    
    seleccionados.forEach(idx => {
        const row = tbody.querySelector(`tr[data-index="${idx}"]`);
        row.classList.add('seleccionado');
        row.querySelector('.selectFila').checked = true;
        if(leafletPoligonos[idx]) leafletPoligonos[idx].setStyle({weight:2});
    });
    
    alert(`‚úÖ ${selected.length} registros ordenados ${ascending ? 'ASC ‚ñ≤' : 'DESC ‚ñº'}`);
}

function getFilaIndex(row) {
  return parseInt(row.getAttribute('data-index'));
}

function toggleSeleccion(idx){
  const fila = document.querySelector(`#tablaPoligonos tbody tr[data-index="${idx}"]`);
  const checkbox = fila.querySelector('input.selectFila');
  
  if(seleccionados.has(idx)){
    seleccionados.delete(idx);
    fila.classList.remove('seleccionado');
    checkbox.checked = false;
    if(leafletPoligonos[idx]) leafletPoligonos[idx].setStyle({weight:0.5});
  } else {
    seleccionados.add(idx);
    fila.classList.add('seleccionado');
    checkbox.checked = true;
    if(leafletPoligonos[idx]) leafletPoligonos[idx].setStyle({weight:2});
  }
}

function scrollFila(idx){
  const fila = document.querySelector(`#tablaPoligonos tbody tr[data-index="${idx}"]`);
  if(fila) fila.scrollIntoView({behavior:"smooth", block:"center"});
}

document.querySelector('#tablaPoligonos tbody').addEventListener('click', function(e){
  if(e.target.tagName === 'INPUT') return;
  const tr = e.target.closest('tr');
  if(tr) {
    const idx = getFilaIndex(tr);
    toggleSeleccion(idx);
    scrollFila(idx);
  }
});

document.querySelector('#tablaPoligonos tbody').addEventListener('change', function(e){
  if(e.target.classList.contains('selectFila')) {
    const idx = getFilaIndex(e.target.closest('tr'));
    toggleSeleccion(idx);
  }
});

document.getElementById('aplicarColor').addEventListener('click', ()=>{
  const color = document.getElementById('colorBloque').value;
  if(!color) return;
  seleccionados.forEach(idx=>{
    const fila = document.querySelector(`#tablaPoligonos tbody tr[data-index="${idx}"]`);
    fila.querySelector('input.colorInput').value = color;
    if(leafletPoligonos[idx]) leafletPoligonos[idx].setStyle({fillColor:color});
  });
});

document.getElementById('seleccionarFiltrados').addEventListener('click', ()=>{
  document.querySelectorAll('#tablaPoligonos tbody tr').forEach(tr => {
    if(tr.style.display !== 'none') {
      const idx = getFilaIndex(tr);
      if(!seleccionados.has(idx)) toggleSeleccion(idx);
    }
  });
});

document.getElementById('deseleccionarTodos').addEventListener('click', ()=>{ 
  Array.from(seleccionados).forEach(idx=> toggleSeleccion(idx)); 
});

document.getElementById('editarColumnas').addEventListener('click', function(){
  if(seleccionados.size === 0){
    alert('Debe seleccionar al menos un registro');
    return;
  }

  const valores = {
    1: document.getElementById('edit-nombre').value.trim(),
    2: document.getElementById('edit-has').value.trim(),
    3: document.getElementById('edit-status').value.trim(),
    4: document.getElementById('edit-status1').value.trim(),
    5: document.getElementById('edit-status2').value.trim(),
    6: document.getElementById('edit-status3').value.trim(),
    7: document.getElementById('edit-partido').value.trim()
  };

  let cambios = 0;
  seleccionados.forEach(idx => {
    const fila = document.querySelector(`#tablaPoligonos tbody tr[data-index="${idx}"]`);
    const inputs = fila.querySelectorAll('input');
    
    Object.keys(valores).forEach(col => {
      if(valores[col] !== '') {
        inputs[col].value = valores[col];
        cambios++;
      }
    });
  });

  document.querySelectorAll('#edicion-masiva input').forEach(inp => inp.value = '');
  alert(`‚úÖ ${cambios} cambios realizados`);
});

document.querySelectorAll('#filtros input').forEach(input => {
  input.addEventListener('keyup', function() {
    const filtros = {};
    document.querySelectorAll('#filtros input').forEach(inp => {
      const col = parseInt(inp.getAttribute('data-col'));
      const val = inp.value.toUpperCase().trim();
      if(val) filtros[col] = val;
    });

    document.querySelectorAll('#tablaPoligonos tbody tr').forEach(row => {
      let show = true;
      Object.keys(filtros).forEach(col => {
        const cellVal = row.querySelectorAll('input')[col].value.toUpperCase();
        if(!cellVal.includes(filtros[col])) show = false;
      });
      row.style.display = show ? '' : 'none';
    });
  });
});

const tabla = document.getElementById("tabla-container");
const header = document.getElementById("tabla-header");
let offsetX, offsetY, dragging=false;
header.addEventListener("mousedown",(e)=>{ dragging=true; offsetX=e.clientX-tabla.offsetLeft; offsetY=e.clientY-tabla.offsetTop; });
document.addEventListener("mouseup",()=>dragging=false);
document.addEventListener("mousemove",(e)=>{ if(!dragging) return; tabla.style.left=(e.clientX-offsetX)+"px"; tabla.style.top=(e.clientY-offsetY)+"px"; });

document.getElementById('btn-grabar').addEventListener('click',()=>{ 
  document.getElementById('menu-grabar').style.display = 
    document.getElementById('menu-grabar').style.display === 'block' ? 'none' : 'block';
});

document.addEventListener('click',function(e){
  if(!e.target.closest('#btn-grabar') && !e.target.closest('#menu-grabar')){ 
    document.getElementById('menu-grabar').style.display = 'none';
  }
});

function obtenerDatos(){
  const filas = [];
  document.querySelectorAll('#tablaPoligonos tbody tr').forEach(tr => {
    const idx = getFilaIndex(tr);
    const inputs = tr.querySelectorAll('input');
    let coords = [];
    if(leafletPoligonos[idx]){
      coords = leafletPoligonos[idx].getLatLngs()[0].map(p => `${p.lng},${p.lat}`).join(" ");
    }
    filas.push({
      name: inputs[1].value,
      superficie: inputs[2].value,
      status: inputs[3].value,
      status1: inputs[4].value,
      status2: inputs[5].value,
      status3: inputs[6].value,
      partido: inputs[7].value,
      color: inputs[8].value,
      COORDENADAS: coords
    });
  });
  return filas;
}

document.getElementById('opcion-grabar').addEventListener('click',()=>{
  fetch('/guardar', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({datos: obtenerDatos()})
  }).then(r=>r.json()).then(resp=>alert(resp.mensaje || 'Guardado'));
  document.getElementById('menu-grabar').style.display = 'none';
});

document.getElementById('opcion-grabar-como').addEventListener('click', async ()=>{
  const fecha = new Date();
  const dd = String(fecha.getDate()).padStart(2,'0');
  const mm = String(fecha.getMonth()+1).padStart(2,'0');
  const aa = String(fecha.getFullYear()).slice(-2);
  const hh = String(fecha.getHours()).padStart(2,'0');
  const min = String(fecha.getMinutes()).padStart(2,'0');
  const sugerido = `poligonos_${dd}-${mm}-${aa}_${hh}-${min}.xlsx`;

  let nuevoNombre = prompt("Nombre del archivo:", sugerido);
  if(!nuevoNombre) { document.getElementById('menu-grabar').style.display = 'none'; return; }
  if(!nuevoNombre.endsWith('.xlsx')) nuevoNombre += '.xlsx';

  try {
    const resp = await fetch('/guardar_como', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({datos: obtenerDatos(), nuevo_nombre: nuevoNombre})
    });
    const json = await resp.json();
    alert(json.mensaje || 'Guardado');
  } catch (err) { 
    alert('Error: ' + err); 
  }
  document.getElementById('menu-grabar').style.display = 'none';
});

document.getElementById('exportarPDF').addEventListener('click',()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const filasPDF = [];
  seleccionados.forEach(idx=>{
    const fila = document.querySelector(`#tablaPoligonos tbody tr[data-index="${idx}"]`);
    const inputs = fila.querySelectorAll('input');
    filasPDF.push([
      inputs[0].checked ? 'X' : '',
      inputs[1].value,
      inputs[2].value,
      inputs[3].value,
      inputs[4].value,
      inputs[5].value,
      inputs[6].value,
      inputs[7].value,
      inputs[8].value
    ]);
  });
  if(filasPDF.length===0){ alert("Seleccione registros"); return; }
  doc.autoTable({
    head: [['Sel','Nombre','Has','Status','Status1','Status2','Status3','Ptdo','Color']],
    body: filasPDF,
    theme: 'grid',
    styles: {fontSize:8},
    margin: {top:10}
  });
  doc.save('poligonos.pdf');
});

document.getElementById("btnLimpiar").addEventListener("click", function() {
    document.querySelectorAll("#filtros input").forEach(input => input.value = "");
    document.querySelectorAll("#edicion-masiva input").forEach(input => input.value = "");
    document.querySelectorAll("#tablaPoligonos tbody tr").forEach(tr => tr.style.display = '');
    document.getElementById("colorBloque").value = "";
    alert("Limpiado");
});

</script>
</body>
</html>